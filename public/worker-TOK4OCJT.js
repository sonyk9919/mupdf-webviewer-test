var v=Object.defineProperty;var w=(i,e,t)=>e in i?v(i,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):i[e]=t;var Y=(i,e,t)=>w(i,typeof e!="symbol"?e+"":e,t);var z={SET_BASE_URI:"setBaseURI",OPEN_DOCUMENT:"openDocument",CLOSE_DOCUMENT:"closeDocument",DOWNLOAD_DOCUMENT:"downloadDocument",DRAW_PAGE:"drawPageAsPNG",LOAD_OUTLINE:"loadOutline",LOAD_PAGE_TEXT:"loadPageText",LOAD_PDFINFO:"loadPdfInfo",LOAD_PDF_LAYOUT:"loadPdfLayout",AUTHENTICATE_PASSWORD:"authenticatePassword",GET_PRINT_URL:"getPrintBlobURL",GET_ANNOTATIONS:"getAnnotations",GET_ACROFORM:"getAcroForm",APPLY_ANNOT_CHANGES:"applyAnnotChanges",APPLY_ACROFIELD_CHANGES:"applyAcroFieldChanges",APPLY_REDACTION:"applyRedaction",GET_STAMP_TEMPLATE_IMAGES:"getStampTemplateImages"};var h,U=class{TOAST_ID=1;fetchSub=null;get buffer(){return this.fetchSub!==null?this.fetchSub:(this.fetchSub=this.fetch().then(e=>e),this.fetchSub)}fetch(){return postMessage(["TOAST",this.TOAST_ID,{action:"SHOW",toastOption:{toastStyle:"notification",content:"LOADING_FALLBACK_FONT_DESC",header:"LOADING_FALLBACK_FONT",timeout:null}}]),new Promise(async(e,t)=>{console.debug("Fetching fallback font.");let s=await fetch(`${V}DroidSansFallback.ttf`);if(!s.ok||s.headers.get("Content-type")!=="font/ttf"){postMessage(["TOAST",this.TOAST_ID,{action:"DISPOSE"}]),t(new Error("Failed to fetch fallback font."));return}let a=new h.Buffer(await s.arrayBuffer());postMessage(["TOAST",this.TOAST_ID,{action:"DISPOSE"}]),e(a)})}},b=class{static isCircle(e){return e.subType===MuPDFAnnotSubType.CIRCLE}static isSquare(e){return e.subType===MuPDFAnnotSubType.SQUARE}static isFreeText(e){return e.subType===MuPDFAnnotSubType.FREE_TEXT}static isRedact(e){return e.subType===MuPDFAnnotSubType.REDACT}static isPopup(e){return e.subType===MuPDFAnnotSubType.POPUP}static isStamp(e){return e.subType===MuPDFAnnotSubType.STAMP}static isHighlight(e){return e.subType===MuPDFAnnotSubType.HIGHLIGHT}static isStrikeOut(e){return e.subType===MuPDFAnnotSubType.STRIKE_OUT}static isUnderline(e){return e.subType===MuPDFAnnotSubType.UNDERLINE}static isTextMarkUp(e){return this.isHighlight(e)||this.isStrikeOut(e)||this.isUnderline(e)}static isText(e){return e.subType===MuPDFAnnotSubType.TEXT}static isLine(e){return e.subType===MuPDFAnnotSubType.LINE}static isPolyLine(e){return e.subType===MuPDFAnnotSubType.POLY_LINE}static isPolygon(e){return e.subType===MuPDFAnnotSubType.POLYGON}static isInk(e){return e.subType===MuPDFAnnotSubType.INK}static isLink(e){return e.subType===MuPDFAnnotSubType.LINK}static isWidget(e){return e.subType===MuPDFAnnotSubType.WIDGET}static isColor(e){return Array.isArray(e)&&e.length===3&&e.every(t=>typeof t=="number")}static isQuadPoint(e){return Array.isArray(e)&&e.length===8&&e.every(t=>typeof t=="number")}static isPoint(e){return Array.isArray(e)&&e.length===2&&e.every(t=>typeof t=="number")}static isRect(e){return Array.isArray(e)&&e.length===4&&e.every(t=>typeof t=="number")}};Y(b,"defaultAppearanceFontNameRegex",/\s*([^\s/]+)\s+\d+\s+Tf/);var x=class{openedDocument;constructor(e){this.openedDocument=e}apply(e,t){if(b.isInk(t)){this.applyInk(e,t);return}if(b.isFreeText(t)){this.applyFreeText(e,t);return}if(b.isTextMarkUp(t)){this.applyTextMarkup(e,t);return}if(b.isText(t)){this.applyText(e,t);return}if(b.isLine(t)){this.applyLine(e,t);return}if(b.isRedact(t)){this.applyRedact(e,t);return}if(b.isLink(t)){this.applyLink(e,t);return}if(b.isStamp(t)){this.applyStamp(e,t);return}if(b.isPolyLine(t)){this.applyPolyLine(e,t);return}if(b.isPolygon(t)){this.applyPolygon(e,t);return}if(b.isCircle(t)){this.applyCircle(e,t);return}if(b.isSquare(t)){this.applySquare(e,t);return}if(b.isPopup(t)){this.applyPopup(e,t);return}if(b.isWidget(t)){this.applyWidget(e,t);return}console.warn(`An unsupported annotation has been entered. ${t}`),this.applyCommonField(e,t)}applyInk(e,t){let a=e.getObject().get("InkList").asJS();t.inkList.every(r=>r.every(o=>b.isPoint(o)))&&!Array.isArray(a)&&e.setInkList(t.inkList),this.applyCommonField(e,t),this.applyCommonShape(e,t),e.update(),this.applyRect(e,t)}applyFreeText(e,t){let s=e.getObject(),a=s.get("CL").asJS();Array.isArray(t.CL)&&(!Array.isArray(a)||a.some((o,c)=>o!==t.CL[c]))&&s.put("CL",t.CL);let r=s.get("RD").asJS();Array.isArray(t.RD)&&(!Array.isArray(r)||r.some((o,c)=>o!==t.RD[c]))&&s.put("RD",t.RD),this.applyCommonField(e,t),this.applyCommonShape(e,t),this.applyDefaultAppearance(e,t),this.applyRect(e,t),this.applyLineEndingStyle(e,t),e.update()}applyTextMarkup(e,t){let a=e.getObject().get("QuadPoints").asJS();t.quadPoints.every(r=>b.isQuadPoint(r))&&(!Array.isArray(a)||t.quadPoints.flat().some((r,o)=>r!==a[o]))&&e.setQuadPoints(t.quadPoints),this.applyCommonField(e,t),this.applyRect(e,t),e.update()}applyText(e,t){this.applyCommonField(e,t),this.applyRect(e,t),e.update()}applyLine(e,t){let s=e.getObject(),a=s.get("L").asJS();t.L.every(c=>b.isPoint(c))&&(!Array.isArray(a)||t.L.flat().some((c,n)=>c!==a[n]))&&e.setLine(t.L[0],t.L[1]);let r=s.get("LL");typeof t.LL=="number"&&(!r.isNumber()||r.getNumber()!==t.LL)&&e.setLineLeader(t.LL);let o=s.get("LLE");typeof t.LLE=="number"&&(!o.isNumber()||o.getNumber()!==t.LLE)&&e.setLineLeaderExtension(t.LLE),this.applyCommonField(e,t),this.applyCommonShape(e,t),this.applyLineEndingStyle(e,t),this.applyRect(e,t),this.applyMeasure(e,t),e.update()}applyRedact(e,t){let s=e.getObject(),a=s.get("OverlayText");typeof t.overlayText=="string"&&(!a.isString()||a.getString()!==t.overlayText)&&s.put("OverlayText",t.overlayText);let r=s.get("OC").asJS();b.isColor(t.OC)&&(!Array.isArray(r)||r.some((o,c)=>o!==t.OC[c]))&&s.put("OC",t.OC),this.applyCommonField(e,t),this.applyCommonShape(e,t),this.applyRect(e,t),this.applyDefaultAppearance(e,t),this.applyAligment(e,t),e.update()}applyLink(e,t){let s=e.getObject();switch(s.put("BS",{W:0}),t.A.S){case MuPDFActionType.GoTo:let a=this.openedDocument.loadPage(t.A.D.page).getObject();s.put("A",{S:t.A.S,D:[a,t.A.D.mode]});break;case MuPDFActionType.URI:s.put("A",{S:t.A.S,URI:`(${t.A.URI})`});break}this.applyCommonField(e,t),this.applyRect(e,t),e.update()}applyStamp(e,t){typeof t.name=="string"&&e.setIcon(t.name),this.applyCommonField(e,t),this.applyRect(e,t),e.update()}applyPolyLine(e,t){this.applyCommonField(e,t),this.applyCommonShape(e,t),this.applyLineEndingStyle(e,t),this.applyRect(e,t),this.applyVertices(e,t),this.applyMeasure(e,t),e.update()}applyPolygon(e,t){this.applyCommonField(e,t),this.applyCommonShape(e,t),this.applyRect(e,t),this.applyVertices(e,t),this.applyMeasure(e,t),e.update()}applyCircle(e,t){this.applyCommonField(e,t),this.applyCommonShape(e,t),this.applyRect(e,t),e.update()}applySquare(e,t){this.applyCommonField(e,t),this.applyCommonShape(e,t),this.applyRect(e,t),e.update()}applyPopup(e,t){this.applyCommonField(e,t),this.applyRect(e,t),e.update()}applyWidget(e,t){this.applyCommonField(e,t),this.applyRect(e,t),e.update()}applyCommonField(e,t){let s=e.getObject(),a=s.get("M");typeof t.M=="string"&&(!a.isString()||a.getString()!==t.M)&&s.put("M",t.M);let r=s.get("C").asJS();b.isColor(t.C)&&(!Array.isArray(r)||r.some((l,y)=>l!==t.C[y]))&&e.setColor(t.C);let o=s.get("Contents");typeof t.contents=="string"&&(!o.isString()||o.getString()!==t.contents)&&e.setContents(t.contents);let c=s.get("F");typeof t.F=="number"&&(!c.isNumber()||c.getNumber()!==t.F)&&e.setFlags(t.F);let n=s.get("T");typeof t.T=="string"&&(!n.isString()||n.getString()!==t.T)&&e.setAuthor(t.T);let p=s.get("CA");typeof t.CA=="number"&&(!p.isNumber()||p.getNumber()!==t.CA)&&e.setOpacity(t.CA);let f=s.get("IT");t.IT&&!f.isName()&&s.put("IT",t.IT);let u=s.get("NM");typeof t.NM=="string"&&!u.isString()&&s.put("NM",`(${t.NM})`);let D=s.get("CreationDate");typeof t.CreationDate=="string"&&!D.isString()&&s.put("CreationDate",`(${t.CreationDate})`)}applyCommonShape(e,t){let s=e.getObject(),a=s.get("BS","W");typeof t.BS?.W=="number"&&(!a.isNumber()||a.getNumber()!==t.BS.W)&&e.setBorderWidth(t.BS.W);let r=s.get("BS","S");t.BS?.S&&(!r.isName()||r.getName()!==t.BS.S)&&e.setBorderStyle(t.BS.S);let o=s.get("BS","D").asJS();t.BS?.S===MuPDFBorderStyle.DASHED&&Array.isArray(t.BS?.D)&&(!Array.isArray(o)||o.some((f,u)=>f!==t.BS.D[u]))?e.setBorderDashPattern(t.BS.D):t.BS?.S===MuPDFBorderStyle.SOLID&&Array.isArray(o)&&o.length>0&&e.setBorderDashPattern([]);let c=s.get("IC").asJS();b.isColor(t.IC)&&(!Array.isArray(c)||c.some((f,u)=>f!==t.IC[u]))?e.setInteriorColor(t.IC):typeof t.IC>"u"&&Array.isArray(c)&&s.delete("IC");let n=s.get("BE","S");t.BE?.S&&(!n.isName()||n.getName()!==t.BE.S)&&e.setBorderEffect(t.BE.S);let p=s.get("BE","I");typeof t.BE?.I=="number"&&(!p.isNumber()||p.getNumber()!==t.BE.I)&&e.setBorderEffectIntensity(t.BE.I)}applyRect(e,t){let s=e.getObject();b.isRect(t.rect)&&s.put("Rect",t.rect)}applyDefaultAppearance(e,t){if(!t.DA||typeof t.DA.fontName!="string"||typeof t.DA.fontSize!="number"||!b.isColor(t.DA.fontColor))return;let{fontName:s,fontSize:a,fontColor:r}=t.DA,c=e.getObject().get("DA");if(!c.isString()){e.setDefaultAppearance(s,a,r);return}let{color:n,font:p,size:f}=e.getDefaultAppearance(),u=c.getString()?.match(b.defaultAppearanceFontNameRegex)?.[1]??p;n.every((D,l)=>D===r[l])&&u===s&&f===a||e.setDefaultAppearance(s,a,r)}applyLineEndingStyle(e,t){if(!Array.isArray(t.LE))return;let s=e.getObject(),[a=MuPDFLineEndingStyle.None,r=MuPDFLineEndingStyle.None]=t.LE;if(b.isFreeText(t)){s.put("LE",a);return}e.setLineEndingStyles(a,r)}applyVertices(e,t){let s=e.getObject().get("Vertices").asJS(),a=Array.isArray(s)&&t.vertices.flat().every((r,o)=>r===s[o]);!t.vertices.every(r=>b.isPoint(r))||a||e.setVertices(t.vertices)}applyMeasure(e,t){let s=t.Measure;if(!s||s.X.length===0)return;let a=e.getObject(),r=a.get("Measure").asJS(),o={C:s.X[0].C,D:s.X[0].D,U:`(${s.X[0].U})`,F:MuPDFFractionType.D,SS:"()",RT:"()",RD:"()"};if(!r||!Array.isArray(r.X)||r.X.length===0){r={Type:"Measure"},r.X=[o],r.D=[{...o,C:1}],r.A=[{...o,U:`(sq ${s.X[0].U})`,C:1}],r.R=s.R,a.put("Measure",r);return}typeof s.X[0].C=="number"&&r.X[0].C!==s.X[0].C&&(r.X[0].C=s.X[0].C),typeof s.X[0].U=="string"&&r.X[0].U!==s.X[0].U&&(r.X[0].U=s.X[0].U,r.D=[{...o,C:1}],r.A=[{...o,U:`sq ${o.U}`,C:1}],r.R=s.R),a.put("Measure",r)}applyAligment(e,t){let s=e.getObject();typeof t.Q=="number"&&s.put("Q",t.Q)}},j=class{widgetOidToKids;constructor(e){this.widgetOidToKids=e}applyAcroField(e,t){let s=e.get("Ff");typeof t.Ff=="number"&&(!s.isNumber()||s.getNumber()!==t.Ff)&&e.put("Ff",t.Ff);let a=e.get("V");t.V!==null&&t.V!==void 0&&(!a.isString()||a.getString()!==t.V)&&this.widgetOidToKids.has(t.oid)&&this.widgetOidToKids.get(t.oid).forEach(o=>this.applyWidget(o,e,t));let r=e.get("T");typeof t.T=="string"&&(!r.isString()||r.getString()!==t.T)&&e.put("T",`(${t.T})`)}applyWidget(e,t,s){let a=e.getObject();switch(s.FT){case MuPDFAcroFieldType.RADIO_BUTTON:case MuPDFAcroFieldType.CHECK_BUTTON:let r=a.get("AP","N");if(r.isIndirect()||!r.isDictionary())return;let o=Object.keys(r.asJS()),c=o.findIndex(f=>f===String(s.V));e.setChoiceValue(c>-1?o[c]:"Off"),e.update();return;case MuPDFAcroFieldType.TEXT_FIELD:if(typeof s.V!="string"){console.warn("The value set in the TextField is not of type string.");return}e.setTextValue(s.V),e.update();return;case MuPDFAcroFieldType.COMBO_BOX:case MuPDFAcroFieldType.LIST_BOX:let n=t.get("Opt").asJS();if(!Array.isArray(n)||!n.every(Array.isArray))return;let p=n.find(f=>f[0]===String(s.V));if(!p||p.length<2)return;e.setChoiceValue(p[1]),e.update();return}}};onmessage=async i=>{let[e,t,s]=i.data;try{if(!h&&e!==z.SET_BASE_URI)throw new Error("set base uri first");let a=await Z[e](...s);postMessage(["RESULT",t,a])}catch(a){if(!(a instanceof Error)){console.error(a),postMessage(["ERROR",t,{}]);return}postMessage(["ERROR",t,a])}};var C=new Map,N=null,V="",k=!1,A=null,$=null;function q(i){let[e,t,s,a,r,o]=i.getTransform(),c=Math.atan2(t,e)*(180/Math.PI);return c<0&&(c=360+c),c}function Q(i,e){let[t,s,a,r]=i.getBounds(),o=e*Math.PI/180,c=Math.cos(o),n=Math.sin(o),p=Math.abs(t*c+s*n),f=Math.abs(-t*n+s*c),u=Math.abs(a*c+r*n),D=Math.abs(-a*n+r*c),l=u-p,y=D-f;return{originalUpperLeftX:p,originalUpperLeftY:f,originalLowerRightX:u,originalLowerRightY:D,width:l,height:y}}function M(i,e){let t=Math.pow(10,e??4);return Math.round(i*t)/t}function _(i,e){return(i&1<<e-1)!==0}function tt(i){return i.isPDF()}function E(i){return`#${i.slice(0,3).map(t=>Math.round(t*255).toString(16).padStart(2,"0")).join("").toUpperCase()}`}function W(i){let t=i.toPixmap(h.Matrix.concat(h.Matrix.identity,h.Matrix.scale(4,4)),h.ColorSpace.DeviceRGB,!0).asPNG();if(t===null)return null;let s=32768,a=[];for(let r=0;r<t.byteLength;r+=s)a.push(String.fromCharCode(...Array.from(t.subarray(r,r+s))));return{data:btoa(a.join("")),format:"png",type:"image"}}function X(i,e){let t=e.get("DA")?.getString()?.match(b.defaultAppearanceFontNameRegex)?.[1];return{strokeColor:E(i.color),fontName:t??i.font,fontSize:i.size}}function H(i,e){let t=i.getObject(),s={},[a,r,o,c]=i.hasRect()?i.getRect():i.getBounds();s.rect={left:M(a),top:M(e-r),right:M(o),bottom:M(e-c)};let n=i.getOpacity();n!==null&&(s.opacity=n),s.Rotate=t.get("Rotate").getNumber()??0;let p=t.get("CreationDate");p.isString()&&(s.CreationDate=p.getString());let f=t.get("M");f.isString()&&(s.M=f.getString());let u=i.getContents();u?.length>0&&(s.contents=u);let D=i.getFlags();if(D!==null&&(s.F=D),!t.get("AP").isNull()){let g=W(i);g!==null&&(s.appearance=g)}if(i.hasAuthor()){let g=i.getAuthor();g?.length>0&&(s.T=g)}let l=t.get("NM");if(l.isString()&&(s.NM=l.getString()),i.hasBorder()){let g=i.getBorderWidth();g!==null&&(s.width=g),s.borderStyle={style:"solid"};let d=i.getBorderStyle();d!==null&&(s.borderStyle.style=d.toLowerCase(),d==="Dashed"&&(s.borderStyle.dashPattern=i.getBorderDashPattern())),i.hasBorderEffect()&&i.getBorderEffect()==="Cloudy"&&(s.borderEffect={style:"C",intensity:i.getBorderEffectIntensity()})}else{let g=t.get("BS","W");g.isNumber()&&(s.width=g.getNumber())}let y=t.get("C");t.get("C").isArray()&&(s.color=E(y.asJS()));let P=t.get("IC");if(t.get("IC").isArray()&&(s.InteriorColor=E(P.asJS())),i.getType()==="Redact"){let g=t.get("OC");if(t.get("OC").isArray()&&(s.OutlineColor=E(g.asJS())),t.get("DA").isString()){let{fontName:T,fontSize:R,strokeColor:S}=X(i.getDefaultAppearance(),t);s.fontName=T,s.fontSize=R,s.fontColor=S}let d=t.get("Q");if(d.isNumber())switch(d.getNumber()){case 0:s.alignment="left";break;case 1:s.alignment="center";break;case 2:s.alignment="right"}let F=t.get("OverlayText");F.isString()&&(s.overlayText=F.getString())}if(i.getType()==="FreeText"){let g=X(i.getDefaultAppearance(),t);s.contentsRichtext={text:i.getContents()??"",borderColor:g.strokeColor,fontName:g.fontName,fontSize:g.fontSize},t.get("DS").getString()?.split(";").forEach(S=>{let[O,L]=S.split(":").map(I=>I.trim());switch(O){case"color":s.contentsRichtext.fontColor=L?.toUpperCase();break;case"text-align":s.contentsRichtext.textAlign=L}});let F=i.getCalloutLine();F!==void 0&&(s.vertices=F.map(S=>{let[O,L]=S;return{x:O,y:e-L}}));let T=t.get("LE");T.isName()&&(s.LE=[T.getName()]);let R=t.get("RD");if(R.isArray()&&R.asJS()?.some(S=>S!==0)){s.textRect={left:s.rect.left,top:s.rect.top,right:s.rect.right,bottom:s.rect.bottom};let[S,O,L,I]=i.getBounds();s.rect={left:M(S),top:M(e-O),right:M(L),bottom:M(e-I)}}}if(i.hasQuadPoints()&&(s.quadPoints=i.getQuadPoints().map(g=>g.reduce((d,F,T)=>(T%2===0&&d.push({x:g[T],y:e-g[T+1]}),d),[]))),i.hasLine()){let[[g,d],[F,T]]=i.getLine();if(s.coordinates={sp:{x:g,y:e-d},ep:{x:F,y:e-T}},i.hasLineEndingStyles()){let{start:O,end:L}=i.getLineEndingStyles();s.LE=[O,L]}t.get("LL").isNumber()&&(s.LL=i.getLineLeader()),t.get("LLE").isNumber()&&(s.LLE=i.getLineLeaderExtension())}let m=t.get("Measure");return m.isDictionary()&&(s.Measure={R:m.get("R").getString()},s.Measure.X=[],m.get("X").forEach(g=>{s.Measure.X.push({C:M(g.get("C").getNumber(),6),D:g.get("D").getNumber(),U:g.get("U").getString()})})),i.hasInkList()&&(s.inkList=i.getInkList().map(g=>g.map(([d,F])=>({x:M(d),y:M(e-F)})))),i.hasVertices()&&(s.vertices=i.getVertices().map(([g,d])=>({x:M(g),y:M(e-d)}))),s}function et(i){let e={},t=i.get("CA");t.isNumber()&&(e.opacity=t.getNumber()),e.Rotate=i.get("Rotate").getNumber()??0;let s=i.get("CreationDate");s.isString()&&(e.CreationDate=s.getString());let a=i.get("M");a.isString()&&(e.M=a.getString());let r=i.get("F");r.isNumber()&&(e.F=r.getNumber());let o=i.get("NM");return o.isString()&&(e.NM=o.getString()),e}function st(i){let e={},t=i.get("Rect");if(t.isArray()){let[l,y,P,m]=t.asJS();e.rect={left:M(l),top:M(m),right:M(P),bottom:M(y)}}let s=i.get("CA");s.isNumber()&&(e.opacity=s.getNumber()),e.Rotate=i.get("Rotate").getNumber()??0;let a=i.get("CreationDate");a.isString()&&(e.CreationDate=a.getString());let r=i.get("M");r.isString()&&(e.M=r.getString());let o=i.get("Contents");if(o.isString()){let l=o.getString();l.length>0&&(e.contents=l)}let c=i.get("F");c.isNumber()&&(e.F=c.getNumber());let n=i.get("NM");n.isString()&&(e.NM=n.getString());let p=i.get("BS","S");if(p.isName())switch(p.getName()){case"D":e.borderStyle={style:"dashed"};let l=i.get("BS","D");e.borderStyle.dashPattern=l.isArray()?l.asJS():[3];break;case"S":default:e.borderStyle={style:"solid"}}let f=i.get("BS","W");f.isNumber()&&(e.width=f.getNumber());let u=i.get("C");u.isArray()&&(e.color=E(u.asJS()));let D=i.get("A","S");switch(D.isName()&&(e.type=D.getName()),e.type){case"GoTo":let l=i.get("A","D");if(l.isArray()){let P=l.get(0,"StructParents");P.isNumber()&&(e.dest=P.toString());let[m,g,...d]=l.asJS();e.fit={mode:g};let F={};switch(g){case"XYZ":F.left=d[0],F.top=d[1],F.zoom=d[2];break;case"FitH":case"FitBH":F.top=d[0];break;case"FitV":case"FitBV":F.left=d[0];break;case"FitR":F.left=d[0],F.bottom=d[1],F.right=d[2],F.top=d[3];break;case"Fit":case"FitB":default:F=null;break}F!==null&&(e.fit.args=F)}break;case"URI":let y=i.get("A","URI");y.isString()&&(e.dest=y.getString())}return e}function it(i,e){let t=H(i,e),s=i.getObject(),a=s.get("FT");a.isName()&&(t.FT=a.getName()),t.Ff=i.getFieldFlags()??0;let r=s.get("T");if(r.isString()&&(t.T=r.getString()),i.isText()||i.isPushButton()||i.isChoice()){let{fontName:u,fontSize:D,strokeColor:l}=X(i.getDefaultAppearance(),s);t.fontName=u,t.fontSize=D,t.fontColor=l}let o=s.get("MK");if(o.isDictionary()){let u=o.get("R");t.MK={R:u.isNumber()?u.getNumber():0};let D=o.get("BG");D.isArray()&&(t.MK.backgroundColor=E(D.asJS()));let l=o.get("BC");l.isArray()&&(t.MK.borderColor=E(l.asJS()));let y=o.get("CA");y.isString()&&(t.MK.CA=y.getString())}let c=s.get("Q");if(c.isNumber())switch(c.getNumber()){case 0:t.alignment="left";break;case 1:t.alignment="center";break;case 2:t.alignment="right"}let n=s.get("Parent");if(n.isIndirect()&&(t.Parent=n.asIndirect(),n.get("FT").getName()==="Btn")){let u=n.get("V");u.isNull()||(t.V=u.valueOf())}let p=s.get("AP","N");if(!p.isIndirect()&&p.isDictionary()){t.AP_N=Object.keys(p.asJS());let u=i.getValue();t.appearance=[{state:u,data:t.appearance.data,format:"png",type:"image"},...t.AP_N.filter(D=>D!==u).reduce((D,l)=>(i.setTextValue(l),D.push({state:l,...W(i)}),i.setTextValue(u),D),[])]}let f=s.get("A","S");if(f.isName()&&(t.type=f.getName(),t.type==="JavaScript")){let u=s.get("A","JS");u.isString()&&(t.JS=u.getString())}return t}var Z={setBaseURI:async i=>{V=`${i}assets/mupdf/`,h=await import(`${V}mupdf.js`)},openDocument:(i,e,t)=>{let s=h.Document.openDocument(i,e);if(!tt(s))throw new Error("doc is not pdf");$=new U,h.installLoadFontFunction((a,r)=>["JP","KR","TC","SC"].includes(r)?A||(k=!0,null):null),C.size===0&&(N=t),C.set(t,{document:s,filename:e,size:i.byteLength})},closeDocument:i=>{let e=i??N;C.get(e)?.document.destroy(),C.delete(e)},downloadDocument:i=>C.get(i??N).document.saveToBuffer().asUint8Array(),drawPageAsPNG:async(i,e,t,s)=>{let a=h.Matrix.identity,r,o,c,n;try{let p=h.Matrix.scale(e,e);a=h.Matrix.concat(a,p);let f=h.Matrix.rotate(t);if(a=h.Matrix.concat(a,f),r=C.get(s??N).document.loadPage(i),c=h.Rect.transform(r.getBounds(),a),o=new h.Pixmap(h.ColorSpace.DeviceRGB,c,!1),o.clear(255),n=new h.DrawDevice(a,o),k=!1,r.runPageContents(n,h.Matrix.identity),k){try{A=await $.buffer}catch(u){console.error(u),h.installLoadFontFunction(()=>null),postMessage(["TOAST",null,{action:"SHOW",toastOption:{toastStyle:"notification",content:"TEXT_RENDER_WARNING",header:"UNAVAILABLE_FONT"}}])}r.runPageContents(n,h.Matrix.identity)}return n.close(),n.destroy(),o?.asPNG()}finally{o?.destroy(),r?.destroy()}},loadOutline:i=>{let e=new Map,t=new Map,s=C.get(i??N).document,a=n=>{let p=(u,D)=>{let l=u.get("Kids");if(l.isNull()){e.set(u.toString(),D);return}l.forEach((y,P)=>{if(typeof P!="number")return;let m=0;for(let g=0;g<P;g++){let d=l.get(g,"Count");d.isNumber()&&(m+=d.getNumber()-1)}p(y,D+P+m)})};if(!n)return null;if(e.has(n))return e.get(n);p(s.getTrailer().get("Root","Pages"),0);let f=e.get(n);return(typeof f!="number"||f<0)&&console.error("Unable to find the target page during bookmark extraction"),f},r=(n,p=!1)=>{let f=n.get("S");if(f.isName()||p)switch(p?"GoTo":f.getName()){case"GoTo":let D=n.get("D");if(D.isArray()){let[l,y,...P]=D.asJS(),m=a(l);if(typeof m=="number"&&m>=0){let g={};switch(y){case"XYZ":g.left=P[0],g.top=P[1],g.zoom=P[2];break;case"FitH":case"FitBH":g.top=P[0];break;case"FitV":case"FitBV":g.left=P[0];break;case"FitR":g.left=P[0],g.bottom=P[1],g.right=P[2],g.top=P[3];break;case"Fit":case"FitB":default:g=null;break}return{pageIndex:m,mode:y,coordinates:g}}}else if(D.isString())return o(D.getString());break}return null},o=n=>{let p=f=>{let u=f.get("Kids"),D=f.get("Names");u.isArray()&&u.forEach(l=>p(l)),D.isArray()&&D.forEach((l,y)=>{if(typeof y!="number"||y%2===1||!l.isString())return;let P=D.get(y+1);if(!P.isNull()){let m=r(P,!0);t.set(l.getString(),m)}})};return t.has(n)||p(s.getTrailer().get("Root","Names","Dests")),t.get(n)},c=n=>{let p=n,f=[];for(;!p.isNull();){let u={},D=p.get("Title"),l=p.get("A"),y=p.get("First"),P=p.get("Dest");y.isNull()||(u.children=c(y)),D.isString()&&(u.text=D.getString());let m=l.isNull()?P.isNull()?null:o(P.getString()):r(l);if(m){let{pageIndex:g,mode:d,coordinates:F}=m;u.dest=g,u.fit=F===null?{mode:d}:{mode:d,args:F}}f.push(u),p=p.get("Next")}return f};return c(s.getTrailer().get("Root","Outlines","First"))},loadPdfInfo:i=>{let{document:e,filename:t,size:s}=C.get(i??N),a={},r={},o=e.getMetaData("format"),[c,n]=o.split(" "),p=new Map([["Author","info:Author"],["CreationDate","info:CreationDate"],["Creator","info:Creator"],["Keywords","info:Keywords"],["ModDate","info:ModDate"],["Producer","info:Producer"],["Subject","info:Subject"],["Title","info:Title"]]),f=new Map([["Printing","print"],["HighQualityPrinting","print-hq"],["ModifyingContents","edit"],["Commenting","annotate"],["FillingForms","form"],["DocumentAssembly","assemble"],["Accessibility","accessibility"],["CopyingContents","copy"]]);p.forEach((l,y)=>a[y]=e.getMetaData(l)),f.forEach((l,y)=>r[y]=e.hasPermission(l));let u={Direction:"R2L"},D=e.getTrailer().get("Root","Root","ViewerPreferences","Direction");return D.isName()&&(u.Direction=D.getName()),{...a,ViewerPreferences:u,PageCount:e.countPages(),Version:n,Security:r,FileName:t,FileSize:s}},loadPageText:(i,e)=>{let s=C.get(e??N).document.loadPage(i),a=s.toStructuredText(["preserve-ligatures","preserve-whitespace","preserve-spans","preserve-images"].join(",")),r=q(s),{width:o,height:c,originalLowerRightY:n}=Q(s,r),p=(P,m)=>{let g=[];for(let d=0;d<P.length;d+=2){let F=P[d],T=P[d+1],R,S;m===90?(R=T,S=c-F):m===180?(R=o-F,S=c-T):m===270?(R=o-T,S=F):(R=F,S=T),g.push(R,S)}return g},f=[],u={text:""},D=[],l,y=()=>{let P=/^\s*$/,m=P.test(u.text)?[]:[...D],g=P.test(u.text)?"":u.text;f.push({...u,rect:m,text:g})};return a.walk({beginLine:(P,m,g)=>{u.isVertical=m===1;let d=Math.atan2(g[1],g[0])*180/Math.PI;d<0&&(d=360+d);let F=Math.abs(r-d);u.rotate=r===d?0:F},onChar:(P,m,g,d,F)=>{let T=[...F],[R,S,O,L,I,J,G,K]=p(T,r),B={left:Math.floor(Math.min(R,O,I,G)),bottom:Math.floor(n-Math.max(S,L,J,K)),right:Math.floor(Math.max(R,O,I,G)),top:Math.floor(n-Math.min(S,L,J,K))};Math.abs(l-B.bottom)>d&&(y(),u.text="",D.length=0),u.text=`${u.text}${P.charCodeAt(0)===65533?" ":P}`,D.push(B),l=B.bottom}}),y(),f},loadPdfLayout:i=>{let e=C.get(i??N).document,t=e.countPages(),s=[];for(let a=0;a<t;a++){let r=e.loadPage(a),o=q(r),{width:c,height:n,originalUpperLeftX:p,originalUpperLeftY:f}=Q(r,o);s.push({bbox:{x:M(p,2),y:M(f,2),w:M(c,2),h:M(n,2)},i:a,r:o,originalR:o,annot:!!(r.getAnnotations().length||r.getWidgets().length),originalIndex:a,ref:a})}return s},authenticatePassword:(i,e)=>C.get(e??N).document.authenticatePassword(i??""),getPrintBlobURL:(i,e,t,s)=>{let a,r;try{a=C.get(s??N).document.loadPage(i);let[o,c,n,p]=a.getBounds(),f=Math.abs(n-o),D=f/72*t,l=Math.round(D/f);r=a.toPixmap(h.Matrix.scale(l,l),h.ColorSpace.DeviceRGB,!1,e,"Print");let y=new Blob([r.asPNG()],{type:"image/png"});return URL.createObjectURL(y)}catch(o){throw o}finally{a?.destroy(),r?.destroy()}},getAnnotations:(i,e)=>{let s=C.get(e??N).document.loadPage(i),[a,r,o,c]=s.getBounds(),n=c-r,p=s.getAnnotations(),f=s.getWidgets(),u=s.getObject().get("Annots"),D=[];u.isArray()&&u.forEach(y=>{y.get("Subtype").getName()==="Link"&&D.push(y)});let l=[];return l.push(...p.map(y=>{try{let P=y.getObject(),m={attributes:{pageIdx:i,...H(y,n)},oid:P.asIndirect(),type:y.getType(),visible:!0},g=P.get("IT");g.isName()&&(m.IT=g.getName());let d=P.get("Popup");if(d.isIndirect()){m.Popup=d.asIndirect();let[T,R,S,O]=y.getPopup();l.push({attributes:{...et(d),pageIndex:i,rect:{left:M(T),top:M(n-R),right:M(S),bottom:M(n-O)}},oid:m.Popup,type:d.get("Subtype").getName()??"Popup",visible:!0})}let F=P.get("IRT");return F.isIndirect()&&(m.IRT=F.asIndirect()),m}catch(P){return console.error(P),null}}).concat(D.map(y=>{try{return{attributes:{pageIdx:i,...st(y)},oid:y.asIndirect(),type:y.get("Subtype").getName()??"Link",visible:!0}}catch(P){return console.error(P),null}})).concat(f.map(y=>{try{return{attributes:{pageIdx:i,...it(y,n)},oid:y.getObject().asIndirect(),type:y.getType()??"Widget",visible:!0}}catch(P){return console.error(P),null}})).filter(y=>y!==null)),l},getAcroForm:i=>{let t=C.get(i??N).document.getTrailer().get("Root","AcroForm");if(t.isNull())return{fields:{},props:{CO:[]}};let s=t.get("Fields"),a={};s.forEach(c=>{let n={};n.oid=c.asIndirect();let p=c.get("FT");p.isName()&&(n.FT=p.getName());let f=c.get("Ff");f.isNumber()&&(n.Ff=f.getNumber(),n.FT==="Btn"?_(n.Ff,16)?n.FT="Rb":_(n.Ff,17)||(n.FT="Cb"):n.FT==="Ch"&&(_(n.Ff,18)?n.FT="Cx":n.FT="Lx"));let u=c.get("T");u.isString()&&(n.T=u.getString());let D=c.get("V");D.isNull()||(n.V=D.asJS());let l=c.get("AA");l.isDictionary()&&(n.AA=l.asJS());let y=c.get("Kids");y.isArray()&&(n.Kids=[],y.forEach((g,d)=>{n.Kids.push({i:d,oid:g.asIndirect()})}));let P=c.get("I");P.isArray()&&(n.I=P.asJS());let m=c.get("Opt");m.isArray()&&(n.Opt=m.asJS()),a[n.oid]=n});let r=[],o=t.get("CO");return o.isArray()&&o.forEach(c=>{r.push({oid:c.asIndirect()})}),{fields:a,props:{CO:r}}},applyAnnotChanges:(i,e)=>{let t=C.get(e??N).document,s=new x(t);i.forEach(a=>{let r=t.loadPage(a.pageIndex);if(!r){console.error("Cannot find a page with annotations to apply the changes.");return}let o=[...r.getAnnotations(),...r.getWidgets()];a.annots.forEach(c=>{switch(c.action){case MuPDFAnnotChangeAction.CREATE:s.apply(r.createAnnotation(c.subType),c);return;case MuPDFAnnotChangeAction.MODIFY:case MuPDFAnnotChangeAction.REMOVE:let n=c.NM;if(!n){console.error("The NM field of the annotation does not exist.");return}let p=o.find(f=>{let u=f.getObject().get("NM");return u.isString()?u.getString()===n:!1});if(!p){console.error(`No annotation for NM (${n})`);return}switch(c.action){case MuPDFAnnotChangeAction.MODIFY:s.apply(p,c);return;case MuPDFAnnotChangeAction.REMOVE:r.deleteAnnotation(p);return}}})})},applyAcroFieldChanges:(i,e)=>{let t=C.get(e??N).document,s=t.getTrailer().get("Root","AcroForm","Fields"),a=t.countPages(),r=new Map,o=new j(r);for(let c=0;c<a;c++)t.loadPage(c).getWidgets().forEach(p=>{let f=p.getObject().get("Parent");if(f.isNull())return;let u=f.asIndirect();if(r.has(u)){r.get(u).push(p);return}r.set(u,[p])});i.forEach(c=>{switch(c.action){case MuPDFAnnotChangeAction.CREATE:case MuPDFAnnotChangeAction.REMOVE:break;case MuPDFAnnotChangeAction.MODIFY:let n=(()=>{let p=[];s.forEach(u=>p.push(u));let f=p.findIndex(u=>u.asIndirect()===c.oid);return f>-1?s.get(f):null})();if(n===null){console.error("AcroField could not be found.",c);return}o.applyAcroField(n,c);break}})},applyRedaction:(i,e)=>{let t=C.get(e??N).document,s=new x(t),a=(r,o)=>{let c=o.getObject().get("Rect");if(c.isNull())return;let n=u=>{let[D,l,y,P]=u;return{left:Math.min(D,y),top:Math.min(l,P),right:Math.max(D,y),bottom:Math.max(l,P)}},p=n(c.asJS());[...r.getAnnotations().filter(u=>u.getObject().get("Subtype").getName()!==MuPDFAnnotSubType.REDACT),...r.getWidgets()].forEach(u=>{let l=u.getObject().get("Rect");if(l.isNull())return;let y=n(l.asJS());y.right<p.left||y.left>p.right||y.top>p.bottom||y.bottom<p.top||r.deleteAnnotation(u)})};i.forEach(r=>{let o=t.loadPage(r.pageIdx),c=o.getAnnotations().filter(n=>n.getType()===MuPDFAnnotSubType.REDACT);r.redactions.forEach(n=>{let p=c.find(f=>{let u=f.getObject().get("NM");return u.isString()&&u.getString()===n.NM});p||(p=o.createAnnotation(MuPDFAnnotSubType.REDACT),s.apply(p,n)),a(o,p),p.applyRedaction(1,h.PDFPage.REDACT_IMAGE_PIXELS,h.PDFPage.REDACT_LINE_ART_REMOVE_IF_COVERED,h.PDFPage.REDACT_TEXT_REMOVE)})})},getStampTemplateImages:i=>{let t=C.get(i??N).document.loadPage(0),s=t.createAnnotation(MuPDFAnnotSubType.STAMP),a=[];return["Approved","AsIs","Confidential","Departmental","Draft","Experimental","Expired","Final","ForComment","ForPublicRelease","NotApproved","NotForPublicRelease","Sold","TopSecret"].forEach(o=>{s.setIcon(o),s.update();let c=W(s);a.push({name:o,data:`data:${c.type}/${c.format};base64, ${c.data}`})}),t.deleteAnnotation(s),a}};postMessage(["INIT",0,Object.keys(Z)]);
